<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ç­–ç•¥çŠ¶æ€é¢æ¿</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/static/imgs/favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: #f4f6f8 url("/static/imgs/CapitalEugene.png") no-repeat center center fixed;
            background-size: cover;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 650px;
            margin: 30px auto;
            background: rgba(255, 255, 255, 0.85);
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .input-group {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .input-group select,
        .input-group button {
            padding: 6px 10px;
            font-size: 1em;
            border: 1px solid #ccc;
        }
        .input-group select {
            border-radius: 4px 0 0 4px;
            outline: none;
        }
        .input-group button {
            border-left: none;
            background: #0066cc;
            color: #fff;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        .section-title {
            font-size: 1.1em;
            color: #666;
            margin-top: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .label {
            font-weight: bold;
            color: #555;
        }
        .value {
            color: #111;
            font-weight: 500;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“Š ç­–ç•¥çŠ¶æ€é¢æ¿</h1>
    <div class="input-group">
        <select id="strategy_select"><option value="">åŠ è½½ä¸­...</option></select>
        <button onclick="loadStrategy()">åŠ è½½</button>
    </div>

    <div class="section-title">ğŸ“ˆ å®æ—¶æŒä»“ä¿¡æ¯</div>
    <div class="item"><span class="label">ç­–ç•¥åç§°</span><span class="value" id="strategy_name">-</span></div>
    <div class="item"><span class="label">å¤šå¤´æŒä»“</span><span class="value" id="long_pos">-</span></div>
    <div class="item"><span class="label">ç©ºå¤´æŒä»“</span><span class="value" id="short_pos">-</span></div>
    <div class="item"><span class="label">å¤šå¤´å…¥åœºä»·</span><span class="value" id="long_entry">-</span></div>
    <div class="item"><span class="label">ç©ºå¤´å…¥åœºä»·</span><span class="value" id="short_entry">-</span></div>
    <div class="item"><span class="label">å¤šå¤´åŠ ä»“æ¬¡æ•°</span><span class="value" id="long_count">-</span></div>
    <div class="item"><span class="label">ç©ºå¤´åŠ ä»“æ¬¡æ•°</span><span class="value" id="short_count">-</span></div>
    <div class="item"><span class="label">æ€»èµ„é‡‘</span><span class="value" id="capital">-</span></div>
    <div class="item"><span class="label">å¤šå¤´äº¤æ˜“ID</span><span class="value" id="long_id">-</span></div>
    <div class="item"><span class="label">ç©ºå¤´äº¤æ˜“ID</span><span class="value" id="short_id">-</span></div>

    <div class="section-title">ğŸ“Š ç­–ç•¥ç»Ÿè®¡ä¿¡æ¯</div>
    <div class="item"><span class="label">æ­¢ç›ˆæ¬¡æ•°</span><span class="value" id="agg_tp_count">-</span></div>
    <div class="item"><span class="label">æ­¢æŸæ¬¡æ•°</span><span class="value" id="agg_sl_count">-</span></div>
    <div class="item"><span class="label">æ­¢ç›ˆæ€»é‡‘é¢</span><span class="value" id="agg_tp_total">-</span></div>
    <div class="item"><span class="label">æ­¢æŸæ€»é‡‘é¢</span><span class="value" id="agg_sl_total">-</span></div>
    <div class="item"><span class="label">å¹³å‡å•æ¬¡ç›ˆåˆ©</span><span class="value" id="agg_avg_profit">-</span></div>
    <div class="item"><span class="label">å¹³å‡å•æ¬¡äºæŸ</span><span class="value" id="agg_avg_loss">-</span></div>
    <div class="item"><span class="label">èµ„é‡‘å˜åŒ–æƒ…å†µ(USDT)</span><span class="value" id="agg_cap_ratio">-</span></div>
    <div class="item"><span class="label">å¹³å‡æŒä»“æ—¶é—´(åˆ†é’Ÿ)</span><span class="value" id="agg_avg_dur">-</span></div>

    <div class="section-title">ğŸ“‰ å®æ—¶Kçº¿å›¾ï¼ˆBTC-SWAPï¼‰</div>
    <div class="input-group">
        <label style="margin-right: 10px; font-weight: bold;">æ—¶åŒº:</label>
        <select id="timezone_select" onchange="updateTimeFormatter()">
            <option value="0">UTC</option>
            <option value="8" selected>UTC+8</option>
        </select>

        <label style="font-weight: bold;">
            <input type="checkbox" id="toggle_zones" checked style="margin-right: 5px;">
            æ˜¾ç¤ºæ”¯æ’‘ / é˜»åŠ›çº¿
        </label>
    </div>
    <div id="kline_info" style="padding: 6px 10px; font-size: 14px; background: #fefefe; color: #000; border-bottom: 1px solid #ccc;"></div>
    <div id="kline_chart" style="height: 400px;"></div>
</div>

<script src="/static/js/kline.js"></script>
<script>
    let strategyName = "";
    let chart, candleSeries;
    let lastTimestamp = 0;
    let klineType = "BTC-USDT-SWAP";
    let timezoneOffsetHours = 8;

    async function fetchAllStrategies() {
        const res = await fetch("/v1/strategy/all");
        const strategies = await res.json();
        const select = document.getElementById("strategy_select");
        select.innerHTML = `<option value="">è¯·é€‰æ‹©ç­–ç•¥</option>`;
        strategies.forEach(name => {
            const option = document.createElement("option");
            option.value = name;
            option.text = name;
            select.appendChild(option);
        });
    }

    async function fetchPosition() {
        if (!strategyName) return;
        const res = await fetch(`/v1/strategy/position/state/${strategyName}`);
        const data = await res.json();
        document.getElementById("strategy_name").innerText = data.strategyShortName || data.strategyFullName || "-";
        document.getElementById("long_pos").innerText = data.longPosition;
        document.getElementById("short_pos").innerText = data.shortPosition;
        document.getElementById("long_entry").innerText = data.longEntryPrice || "-";
        document.getElementById("short_entry").innerText = data.shortEntryPrice || "-";
        document.getElementById("long_count").innerText = data.longAddCount;
        document.getElementById("short_count").innerText = data.shortAddCount;
        document.getElementById("capital").innerText = data.capital + " USDT";
        document.getElementById("long_id").innerText = data.longTransactionId || "-";
        document.getElementById("short_id").innerText = data.shortTransactionId || "-";
    }

    async function fetchAggregate() {
        if (!strategyName) return;
        const res = await fetch(`/v1/strategy/aggregate/${strategyName}`);
        const data = await res.json();

        document.getElementById("agg_tp_count").innerText = data.takeProfitCount ?? "-";
        document.getElementById("agg_sl_count").innerText = data.stopLossCount ?? "-";
        document.getElementById("agg_tp_total").innerText = data.totalTakeProfitAmount ?? "-";
        document.getElementById("agg_sl_total").innerText = data.totalStopLossAmount ?? "-";
        document.getElementById("agg_avg_profit").innerText = data.avgProfitPerTrade ?? "-";
        document.getElementById("agg_avg_loss").innerText = data.avgLossPerTrade ?? "-";
        document.getElementById("agg_cap_ratio").innerText = data.capitalChange ?? "-";
        document.getElementById("agg_avg_dur").innerText = data.avgHoldingDuration ?? "-";
    }

    function loadStrategy() {
        strategyName = document.getElementById("strategy_select").value;
        if (!strategyName) return alert("è¯·é€‰æ‹©ç­–ç•¥");
        fetchPosition();
        fetchAggregate();
    }

    function initKlineChart() {
        const container = document.getElementById("kline_chart");
        chart = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: 400,
            layout: { background: { color: '#fff' }, textColor: '#000' },
            grid: { vertLines: { color: '#eee' }, horzLines: { color: '#eee' } },
            timeScale: {
                timeVisible: true,
                secondsVisible: false,
                tickMarkFormatter: (unixTime) => {
                    const date = new Date(unixTime * 1000);
                    return date.toLocaleTimeString('zh-CN', {
                        hour: '2-digit', minute: '2-digit',
                        hour12: false,
                        timeZone: timezoneOffsetHours === 0 ? 'UTC' : 'Asia/Shanghai'
                    });
                }
            }
        });

        chart.subscribeCrosshairMove(function(param) {
            const infoDiv = document.getElementById("kline_info");
            if (!param || !param.time || !param.seriesData) {
                infoDiv.innerText = "";
                return;
            }

            const bar = param.seriesData.get(candleSeries);
            if (!bar) {
                infoDiv.innerText = "";
                return;
            }

            const open = bar.open;
            const high = bar.high;
            const low = bar.low;
            const close = bar.close;

            const amplitude = high - low;
            const change = close - open;
            const changePercent = open === 0 ? 0 : (change / open * 100);

            infoDiv.innerHTML = `
                å¼€=${open.toFixed(2)}
                é«˜=${high.toFixed(2)}
                ä½=${low.toFixed(2)}
                æ”¶=${close.toFixed(2)}
                æŒ¯å¹…=${amplitude.toFixed(2)}
                æ¶¨è·Œ=${change >= 0 ? "+" : ""}${change.toFixed(2)} (${changePercent >= 0 ? "+" : ""}${changePercent.toFixed(2)}%)
            `;
        });


        candleSeries = chart.addCandlestickSeries();
        updateTimeFormatter();
    }

    async function fetchKlineUpdate() {
        const res = await fetch(`/v1/kline/${klineType}`);
        const data = await res.json();
        const formatted = data.map(d => ({
            time: Math.floor(d.timestamp / 1000),  // âš ï¸ ä¸è¦åŠ  offset
            open: parseFloat(d.open),
            high: parseFloat(d.high),
            low: parseFloat(d.low),
            close: parseFloat(d.close),
        }));

        if (lastTimestamp === 0 && formatted.length) {
            candleSeries.setData(formatted);
            lastTimestamp = formatted.at(-1).time;
        } else {
            const newBars = formatted.filter(b => b.time > lastTimestamp);
            newBars.forEach(bar => candleSeries.update(bar));
            if (newBars.length) lastTimestamp = newBars.at(-1).time;
        }
    }

    function updateTimeFormatter() {
        timezoneOffsetHours = parseInt(document.getElementById("timezone_select").value);
        const timeZone = timezoneOffsetHours === 0 ? 'UTC' : 'Asia/Shanghai';

        chart.applyOptions({
            timeScale: {
                tickMarkFormatter: (unixTime) => {
                    const date = new Date(unixTime * 1000);
                    return date.toLocaleTimeString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false,
                        timeZone: timeZone
                    });
                }
            },
            localization: {
                timeFormatter: (unixTime) => {
                    const date = new Date(unixTime * 1000);
                    return date.toLocaleString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false,
                        timeZone: timeZone
                    });
                }
            }
        });
    }
</script>
<script>
    let zoneSeries = [];

    async function fetchAndRenderZones() {
        const checkbox = document.getElementById("toggle_zones");
        if (!checkbox || !checkbox.checked) {
            // âŒ æ²¡å‹¾é€‰ï¼šæ¸…é™¤å·²æœ‰çº¿
            if (!chart) return;  // ğŸ” chart å°šæœªåˆå§‹åŒ–ï¼Œå…ˆé€€å‡º
            zoneSeries.forEach(series => {
                if (series && typeof chart.removeSeries === 'function') {
                    try {
                        chart.removeSeries(series);
                    } catch (e) {
                        console.warn("ç§»é™¤çº¿å¤±è´¥:", e);
                    }
                }
            });
            zoneSeries = [];
            return;
        }

        try {
            const res = await fetch(`/v1/level-lines/${klineType}`);
            const levels = await res.json();

            // æ¸…é™¤æ—§çº¿
            zoneSeries.forEach(series => {
                if (series) {
                    try {
                        chart.removeSeries(series);
                    } catch (e) {
                        console.warn("ç§»é™¤çº¿å¤±è´¥:", e);
                    }
                }
            });
            zoneSeries = [];
            const currentTime = lastTimestamp || Math.floor(Date.now() / 1000);

            levels.forEach(level => {
                const volume = parseFloat(level.totalVolume);
                const scaledVolume = Math.min(6, 1.5 + Math.log10(volume + 1));  // æ›´å¹³æ»‘

                const line = chart.addLineSeries();
                line.applyOptions({
                    color: level.type === "support" ? "#00b300" : "#cc0000",
                    lineWidth: scaledVolume,
                    priceLineVisible: true,
                    lastValueVisible: false,
                    crossHairMarkerVisible: false,
                    priceLineStyle: 2,
                    title: `${level.type === "support" ? "æ”¯æ’‘" : "é˜»åŠ›"}: ${level.totalVolume}`
                });
                line.setData([{ time: currentTime, value: parseFloat(level.price) }]);
                zoneSeries.push(line);
            });
        } catch (err) {
            console.error("åŒºé—´åŠ è½½å¤±è´¥:", err);
        }
    }
</script>
<script>
    window.addEventListener("load", () => {
        fetchAllStrategies();
        initKlineChart();
        fetchKlineUpdate();
        setInterval(fetchKlineUpdate, 1000);
        setInterval(fetchPosition, 1000);

        // âœ… å¿…é¡»æ”¾åœ¨ chart åˆå§‹åŒ–ä¹‹åå†æ‰§è¡Œ
        setTimeout(() => {
            fetchAndRenderZones();                    // åˆæ¬¡åŠ è½½
            setInterval(fetchAndRenderZones, 1000);   // æ¯ 5 ç§’è‡ªåŠ¨åˆ·æ–°
        }, 500);  // å»¶è¿Ÿæ‰§è¡Œ
    });
</script>
</body>
</html>
